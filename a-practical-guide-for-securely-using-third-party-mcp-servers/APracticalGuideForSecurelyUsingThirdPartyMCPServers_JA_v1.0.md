<h1>目次</h1>

${toc}

------------------------------------------------------

# サードパーティ製 MCP サーバーのセキュアな使用に関する実践ガイド

### 第 1.0 版
### 2025 年 10 月 23 日

※配布元 = https://genai.owasp.org/resource/cheatsheet-a-practical-guide-for-securely-using-third-party-mcp-servers-1-0/
※原文 = https://genai.owasp.org/download/51928/?tmstv=1762283701

# ライセンスおよび用途

This document is licensed under Creative Commons, CC BY-SA 4.0.

You are free to:
Share — copy and redistribute the material in any medium or format for any purpose, even commercially.
Adapt — remix, transform, and build upon the material for any purpose, even commercially.

The licensor cannot revoke these freedoms as long as you follow the license terms.
Under the following terms:
Attribution — You must give appropriate credit, provide a link to the license, and indicate if changes were
made. You may do so in any reasonable manner, but not in any way that suggests the licensor endorses you
or your use.
ShareAlike — If you remix, transform, or build upon the material, you must distribute your contributions under
the same license as the original.
No additional restrictions — You may not apply legal terms or technological measures that legally restrict
others from doing anything the license permits.

Link to full license text: https://creativecommons.org/licenses/by-sa/4.0/legalcode

The information provided in this document does not, and is not intended to constitute legal advice. All
information is for general informational purposes only.
This document contains links to other third-party websites. Such links are only for convenience and OWASP
does not recommend or endorse the contents of the third-party sites.

# 導入と背景

このチート シートは、サードパーティ製の MCP（つまり、自社組織内で開発されていない MCP）の使用を計画している企業や開発者を対象としています。MCP 開発者向けのチート シートではありません。

**モデル コンテキスト プロトコル（MCP）** は、LLM/エージェント ホストがサーバー経由で外部ツール、データ、プロンプト テンプレートに接続する方法を標準化するオープンなプロトコルです。モデルをデータベース、API、社内アプリケーションなどのシステムに接続することで、MCP は強力な自動化を実現し、AI がテキスト生成以外のアクションを実行できるようにします。しかし、MCP は新たな攻撃対象領域も生み出し、組織を悪意のある攻撃にさらす可能性があります。ツールはコードの実行、ファイルへのアクセス、ネットワーク呼び出しを行うことができるため、MCP スタックが侵害されると、データの盗難、悪意のあるコードの実行、システムの妨害につながる可能性があります。

MCP は、API セマンティクス用の**データ層**（JSON-RPC）と通信用の**トランスポート層**（STDIO、Streamable HTTPなど）という 2 つの主要層で構成されるシンプルなクライアント-サーバーモデルを採用しています。

- **MCP ホスト**: クライアントを管理し、リクエストをルーティングするアプリケーション（例: AI エージェント ランタイム）。
- **MCP クライアント**: 単一の MCP サーバーと通信するコネクタ。
- **MCP サーバー**: クライアントにツールとコンテキスト（例: カレンダー、SaaS API）を公開するプログラム。MCP は、サーバーが公開できる 以下の 3 つのコア プリミティブを定義します。
	- ツール: AI アプリケーションがアクションを実行するために呼び出すことができる実行可能関数（例: ファイル操作、API 呼び出し、データベース クエリ）。
	- リソース: AI アプリケーションにコンテキスト情報を提供するデータソース（例: ファイルの内容、データベース レコード、API レスポンス）。モデルへの参照。
	- プロンプト: 言語モデルとのインタラクションを構造化するのに役立つ再利用可能なテンプレート（例: システム プロンプト、Few-Shot の例）。

このチート シートは、（MCP をセキュアに使用して）サードパーティ製の MCP サーバーを使用する開発者向けの主要なセキュリティ管理策の概要を示します。

## 利用事例

<div align="center">

![Fig-01.jpg](_resources/Fig-01.jpg)
</div>

ダウンロード可能な MCP サーバーは、ローカルで実行され、ネイティブ ツールとシステム レベルの権限を使用して、外部インフラストラクチャに依存しないタスクを実行します。これらのシステムでは、MCP クライアントとサーバー間の通信に STDIO を使用することがよくあります。コア操作はローカルで実行されますが、LLM 実行やリモート API 呼び出しなどの一部の機能は、構成に応じてリモート サービスと連携する場合があります。

<div align="center">

![Fig-02.jpg](_resources/Fig-02.jpg)
</div>

この MCP クライアントは、MCP の HTTP Streamable 通信を介してサーバーに接続し、サーバーはリモートで実行されます。サーバーは、多くの場合クラウド環境でホストされている外部ツールや API と連携する機能を持ちます。このデプロイメントにおける主要な考慮事項には、認証/認可、サーバーの検出、そしてレビューされていない MCP ツールの変更が含まれます。

# 現時点での脆弱性の状況

MCP をめぐっては、一般的な攻撃パターンが出現し始めています。その多くは、LLM に影響を与えることを目的とした悪意のある入力、または LLM が呼び出すツールに影響を与える攻撃に焦点が当てられています。

## ツール汚染とラグ プル攻撃

ツール汚染は、攻撃者がツールの説明またはパラメータ内に悪意のあるコマンドを埋め込む間接的なプロンプト インジェクションの一種です。LLM はこれらの隠された命令を実行し、データやファイル システムへの不正アクセスにつながる可能性があります。ラグ プルは、正規のツールが不正なバージョンに密かに置き換えられ、元のツールによって確立された信頼関係を利用して攻撃を実行する、ツール汚染の特定の種類です。

### 軽減策

- **ツールの完全な透明性の確保**: MCP クライアントは、ユーザーがツールをアクティブ化する前に、説明、パラメータ、機能を含む完全なツールマニフェストを表示する必要があります。挿入された命令を隠す可能性のあるため、短縮された要約の表示は避けます。
- **説明の無害化**: 説明に疑わしいキーワードやマーク アップがないか確認します。[OWASP
LLM Prompt Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/LLM_Prompt_Injection_Prevention_Cheat_Sheet.html) を参考にします。入手可能な場合は MCP コード全体をレビューし、ツール名と説明およびコードを比較して、疑わしい不一致を特定します。
- **ツールの整合性とバージョンの監視**: クライアントは、最初のユーザー承認時に MCP サーバーとそのツールのバージョンを固定する必要があります。ハッシュまたはチェック サムを使用して、ツールの説明と機能が悪意を持って変更されていないことを検証します。バージョン履歴を維持し、不正な変更があった場合は管理者に警告します。
- **ランタイム ポリシーの適用**: MCP サーバーの境界（ホスト/コンテナ/プロキシ）で最小権限ポリシーを適用し、ツールによるローカル ファイルの読み取り、機密 API へのアクセス、データの抽出を制限します。

## プロンプト インジェクション

攻撃者は、悪意のあるユーザー入力、ツールによって取得されたコンテンツ、またはツールの引数を利用してモデルのコンテキストを乗っ取り、危険なツールの呼び出し、[会話履歴の漏洩]()、安全ポリシーの無効化など、意図しないアクションを実行させます。

### 軽減策

- **信頼できないデータの検証**: ツールの説明やサーバーの応答、ユーザー入力など、すべての外部データをモデルに渡す前に無害化および検証します。[OWASP
LLM Prompt Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/LLM_Prompt_Injection_Prevention_Cheat_Sheet.html) の「Input Validation and Sanitization（入力の検証と無害化）」セクションを参考にします。
- **強力なスキーマの使用**: すべてのツール入力に対して厳格な JSON/YAML スキーマを定義し適用します。検証には、Pydantic (Python) や JSON Schema などのライブラリを使用します。
- **コンテキストのセグメント化**: 異なるユーザーとのクライアント インタラクションをセグメント化し、新しい操作または別の操作にはサードパーティ製 MCP サーバーとの新しい接続/セッションを確立します。

## 記憶の汚染

この攻撃は、エージェントの短期または長期記憶（例: ベクトル データベース）を破壊し、誤った情報を保存したり、セキュリティ チェックを回避したり、誤った判断を下したりさせます。これは、システム全体の誤情報や権限昇格につながる可能性があります。

### 軽減策

- **記憶の保護と検証**: すべての記憶領域の更新時に検証を実施します。異常をスキャンし、ソースのアトリビューションを要求し、暗号ハッシュを使用します。
- **記憶保持の制限**: 保存されたデータにTTL（Time-To-Live）を実装し、古くなった情報や悪意のある情報が永続化されるのを防ぎます。
- **記憶のセグメント化**: エージェントによる共有記憶ストアへの書き込みを防止し、連鎖的な障害を回避します。セッションまたはユーザー ID ごとに記憶を分離します。

### ツールの干渉

複数の MCP サーバーを使用すると、意図しないツール実行チェーンが発生する可能性があります。あるツールからの LLM 出力が、別のサーバーのツールを誤ってトリガーし、データ漏洩、誤操作、またはサービス拒否ループを引き起こす可能性があります。

### 軽減策

- **人間の介入 (Human-in-the-Loop) の要求**: ユーザーが設定可能なサーバーの場合、ツールを実行する前に承認フローを実装し、ユーザーがアクションを認識できるようにします。エージェント型システムの場合は、階層型 HITL 戦略を選択して、堅牢な監視を実現します。
- **コンテキストの分離**: 各ツール実行のコンテキストを分離し、必要な情報のみをツール間で受け渡します。実行ごとに LLM コンテキストをリセットします。
- **タイムアウトの設定**: 実装が不十分なツールやループするツールがホストに影響を与えないように、実行タイム アウトを実装します。

# クライアントのセキュリティとサーバーの検出

MCP クライアントと MCP サーバーのセキュリティ責任と攻撃対象領域を理解することは、包括的な保護を実装するために不可欠です。それぞれの側は固有の脅威に直面しており、それぞれに合わせたセキュリティ対策が必要です。

## MCP クライアントのセキュリティに関する考慮事項

クライアントは多くの場合、アプリケーションに組み込まれています。ツールの利用者として機能し、悪意のあるサーバーに対する最前線の防御となります。

- **信頼の最小化**: サーバーが信頼できると想定せず、常にマニフェストを検証し、スキーマを適用し、許可リストを適用します。
- **サンド ボックス実行**: サーバーが侵害された場合の影響を軽減するため、クライアントを制限された環境（ファイル システム/ネットワーク アクセスが制限されたコンテナなど）で実行します。
- **コンテナ（Dockerなど）を使用してサード パーティ製の MCP サーバーを実行します**。Docker コンテナは標準化された隔離環境を提供し、侵害されたサーバーがホスト システムのリソース、ファイル、ネットワークにアクセスするのを防ぎます。
- **ジャスト イン タイム（JIT）アクセス**: 特定のタスクの実行中のみ、ツールに一時的に限定された権限を付与します。権限は自動的に期限切れになり、即座に取り消されます。
- **UI の透明性**: ツールの実行前に、ツールの完全な説明、権限、データ アクセスをユーザーに公開します。リスクを隠すような非表示または「要約」されたビューは避けます。
- **ローカル データ保護**: クライアント側のシークレット、履歴、またはキャッシュされた記憶がサーバーから流出することを防止します。LLM に渡されるすべてのデータを無害化します。
- **インシデント検出**: 異常なツール呼び出しパターン（大量のファイル読み取り、過剰な API 呼び出しなど）を監視し、アラートをトリガーします。

## サーバーの検出と検証

MCP サーバーを使用する上で重要な段階は「検出」です。この段階では、サーバーが識別、検証され、接続されます。

### 検出と接続

- **接続前のオリジン検証**: 信頼できるレジストリからのサーバーにのみ接続します。IP 許可リストとネットワーク分離を使用して、不明なサーバーへの接続を防止します。オープンソース ツールまたはローカルにホストされているサーバーの場合は、常にソースを検証し、署名を確認し、既知の脆弱性や悪意のある変更がないかスキャンします。
- **利用サーバーをレジストリに限定**: 承認済みの全サーバーを中央のレジストリで一元管理します。
- **ホスティングと接続の典型例の選択**:
	- **STDIO（ローカル接続）**: ローカルにホストされている MCP サーバー（サード パーティのリポジトリまたはベンダーからダウンロード）の場合は、MCP サーバーのサブ プロセスへの接続として STDIO を使用します。このアプローチはレイテンシが最も低く、プロセス サンドボックス、[seccomp]()、または [AppArmor]() による強化が容易です。
	- **Streamable HTTP（リモート接続）**: リモート サーバー、マルチテナント サーバー、または自動スケーリング サーバーの場合は、Streamable HTTP 経由のリモート接続を使用します。堅牢な認証には TLS/mTLS または OAuth 2.1 を使用し、WAF とレート制限機能で保護します。認証情報（API キー、証明書）は定期的に変更します。

### 検証

- **バージョンの固定**: 承認済みサーバーとツールのバージョンのマニフェストを維持します。チェック サムを使用して整合性を検証し、悪意のあるアップグレードを未然に防ぎます。
- **段階的なロール アウト**: まず、完全なテレメトリを備えたステージング環境で新しいサーバーを有効にします。インシデントが発生しない試用期間が経過した場合にのみ、本番環境に移行します。リグレッションや侵害が発生した場合に備えて、ロール バック手順を自動化します。
- **人間による承認の記録**: すべてのセキュリティおよびドメイン所有者の承認をレジストリに記録します。承認済みのサーバー インベントリからの逸脱を監視し、アラートを発します。

## 認証と認可

ローカルまたはリモートの MCP サーバーへのセキュアな接続には、認証と認可の両方が不可欠です。MCP は仕様の一部として OAuth 2.1 を実装しており、実装のガイドとして使用できます。ただし、MCP アーキテクチャが異なると、それぞれ異なる OAuth 設定が必要になることに注意してください。

### 認証


### 認可

